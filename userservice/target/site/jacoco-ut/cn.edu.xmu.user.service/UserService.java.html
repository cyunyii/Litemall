<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UserService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">userservice</a> &gt; <a href="index.source.html" class="el_package">cn.edu.xmu.user.service</a> &gt; <span class="el_source">UserService.java</span></div><h1>UserService.java</h1><pre class="source lang-java linenums">package cn.edu.xmu.user.service;

import cn.edu.xmu.ooad.model.VoObject;
import cn.edu.xmu.ooad.util.JwtHelper;
import cn.edu.xmu.ooad.util.ResponseCode;
import cn.edu.xmu.ooad.util.ReturnObject;
import cn.edu.xmu.ooad.util.encript.AES;
import cn.edu.xmu.user.dao.NewUserDao;
import cn.edu.xmu.user.dao.UserDao;
import cn.edu.xmu.user.model.bo.Customer;
import cn.edu.xmu.user.model.vo.NewUserVo;
import com.github.pagehelper.PageInfo;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.io.Serializable;
import java.time.LocalDateTime;
import java.time.ZoneOffset;
import java.util.Random;
import java.util.Set;
import java.util.concurrent.TimeUnit;

@Service
<span class="fc" id="L29">public class UserService {</span>
    @Value(&quot;${userservice.login.jwtExpire}&quot;)
    private Integer jwtExpireTime;

<span class="fc" id="L33">    private static final Logger logger = LoggerFactory.getLogger(UserService.class);</span>
    @Value(&quot;${userservice.login.multiply}&quot;)
    private Boolean canMultiplyLogin;

    /**
     * 分布式锁的过期时间（秒）
     */
    @Value(&quot;${userservice.lockerExpireTime}&quot;)
    private long lockerExpireTime;

    @Autowired
    private RedisTemplate&lt;String, Serializable&gt; redisTemplate;

    @Autowired
    NewUserDao newUserDao;

    @Autowired
    UserDao userDao;

    /**
     * @param vo 注册的vo对象
     * @return ReturnObject
     * @author LiangJi3229
     */
    @Transactional
    public ReturnObject register(NewUserVo vo) {
<span class="fc" id="L59">        return newUserDao.createNewUserByVo(vo);</span>
    }


    @Transactional
    public ReturnObject&lt;String&gt; login(String userName, String password, String ipAddr)
    {
<span class="fc" id="L66">        ReturnObject retObj = userDao.getUserByName(userName);</span>
<span class="pc bpc" id="L67" title="1 of 2 branches missed.">        if (retObj.getCode() != ResponseCode.OK){</span>
<span class="nc" id="L68">            return retObj;</span>
        }

<span class="fc" id="L71">        Customer user = (Customer) retObj.getData();</span>
<span class="fc" id="L72">        password = AES.encrypt(password, Customer.AESPASS);</span>
<span class="pc bpc" id="L73" title="2 of 4 branches missed.">        if(user == null || !password.equals(user.getPassword())){</span>
<span class="nc" id="L74">            retObj = new ReturnObject&lt;&gt;(ResponseCode.AUTH_INVALID_ACCOUNT);</span>
<span class="nc" id="L75">            return retObj;</span>
        }
<span class="pc bpc" id="L77" title="1 of 2 branches missed.">        if (user.getState() != Customer.State.NORM){</span>
<span class="nc" id="L78">            retObj = new ReturnObject&lt;&gt;(ResponseCode.AUTH_USER_FORBIDDEN);</span>
<span class="nc" id="L79">            return retObj;</span>
        }

<span class="fc" id="L82">        String key = &quot;up_&quot; + user.getId();</span>
<span class="pc bpc" id="L83" title="3 of 4 branches missed.">        if(redisTemplate.hasKey(key) &amp;&amp; !canMultiplyLogin){</span>
//            logger.debug(&quot;login: multiply  login key =&quot;+key);
            // 用户重复登录处理
<span class="nc" id="L86">            Set&lt;Serializable&gt; set = redisTemplate.opsForSet().members(key);</span>
<span class="nc" id="L87">            redisTemplate.delete(key);</span>

            /* 将旧JWT加入需要踢出的集合 */
<span class="nc" id="L90">            String jwt = null;</span>
<span class="nc bnc" id="L91" title="All 2 branches missed.">            for (Serializable str : set) {</span>
                /* 找出JWT */
<span class="nc bnc" id="L93" title="All 2 branches missed.">                if((str.toString()).length() &gt; 8){</span>
<span class="nc" id="L94">                    jwt =  str.toString();</span>
<span class="nc" id="L95">                    break;</span>
                }
<span class="nc" id="L97">            }</span>
<span class="nc" id="L98">            this.banJwt(jwt);</span>
        }


        //创建新的token
<span class="fc" id="L103">        JwtHelper jwtHelper = new JwtHelper();</span>
<span class="fc" id="L104">        Random random = new Random();</span>
<span class="fc" id="L105">        Long milliSecond = LocalDateTime.now().toInstant(ZoneOffset.of(&quot;+8&quot;)).toEpochMilli()+random.nextInt();</span>
<span class="fc" id="L106">        String jwt = jwtHelper.createToken(user.getId(),milliSecond, jwtExpireTime);</span>
<span class="fc" id="L107">        redisTemplate.opsForSet().add(key, jwt);</span>
<span class="fc" id="L108">        logger.debug(&quot;login: newJwt = &quot;+ jwt);</span>
<span class="fc" id="L109">        retObj = new ReturnObject&lt;&gt;(jwt);</span>

<span class="fc" id="L111">        return retObj;</span>
    }

    /**
     * 禁止持有特定令牌的用户登录
     * @param jwt JWT令牌
     */
    private void banJwt(String jwt){
<span class="nc" id="L119">        String[] banSetName = {&quot;BanJwt_0&quot;, &quot;BanJwt_1&quot;};</span>
<span class="nc" id="L120">        long bannIndex = 0;</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">        if (!redisTemplate.hasKey(&quot;banIndex&quot;)){</span>
<span class="nc" id="L122">            redisTemplate.opsForValue().set(&quot;banIndex&quot;, Long.valueOf(0));</span>
        } else {
<span class="nc" id="L124">            logger.debug(&quot;banJwt: banIndex = &quot; +redisTemplate.opsForValue().get(&quot;banIndex&quot;));</span>
<span class="nc" id="L125">            bannIndex = Long.parseLong(redisTemplate.opsForValue().get(&quot;banIndex&quot;).toString());</span>
        }
<span class="nc" id="L127">        logger.debug(&quot;banJwt: banIndex = &quot; + bannIndex);</span>
<span class="nc" id="L128">        String currentSetName = banSetName[(int) (bannIndex % banSetName.length)];</span>
<span class="nc" id="L129">        logger.debug(&quot;banJwt: currentSetName = &quot; + currentSetName);</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">        if(!redisTemplate.hasKey(currentSetName)) {</span>
            // 新建
<span class="nc" id="L132">            logger.debug(&quot;banJwt: create ban set&quot; + currentSetName);</span>
<span class="nc" id="L133">            redisTemplate.opsForSet().add(currentSetName, jwt);</span>
<span class="nc" id="L134">            redisTemplate.expire(currentSetName,jwtExpireTime * 2, TimeUnit.SECONDS);</span>
        }else{
            //准备向其中添加元素
<span class="nc bnc" id="L137" title="All 2 branches missed.">            if(redisTemplate.getExpire(currentSetName, TimeUnit.SECONDS) &gt; jwtExpireTime) {</span>
                // 有效期还长，直接加入
<span class="nc" id="L139">                logger.debug(&quot;banJwt: add to exist ban set&quot; + currentSetName);</span>
<span class="nc" id="L140">                redisTemplate.opsForSet().add(currentSetName, jwt);</span>
            } else {
                // 有效期不够JWT的过期时间，准备用第二集合，让第一个集合自然过期
                // 分步式加锁
<span class="nc" id="L144">                logger.debug(&quot;banJwt: switch to next ban set&quot; + currentSetName);</span>
<span class="nc" id="L145">                long newBanIndex = bannIndex;</span>
<span class="nc bnc" id="L146" title="All 2 branches missed.">                while (newBanIndex == bannIndex &amp;&amp;</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">                        !redisTemplate.opsForValue().setIfAbsent(&quot;banIndexLocker&quot;,&quot;nouse&quot;, lockerExpireTime, TimeUnit.SECONDS)){</span>
                    //如果BanIndex没被其他线程改变，且锁获取不到
                    try {
<span class="nc" id="L150">                        Thread.sleep(10);</span>
                        //重新获得新的BanIndex
<span class="nc" id="L152">                        newBanIndex = (Long) redisTemplate.opsForValue().get(&quot;banIndex&quot;);</span>
<span class="nc" id="L153">                    }catch (InterruptedException e){</span>
<span class="nc" id="L154">                        logger.error(&quot;banJwt: 锁等待被打断&quot;);</span>
                    }
<span class="nc" id="L156">                    catch (IllegalArgumentException e){</span>

<span class="nc" id="L158">                    }</span>
                }
<span class="nc bnc" id="L160" title="All 2 branches missed.">                if (newBanIndex == bannIndex) {</span>
                    //切换ban set
<span class="nc" id="L162">                    bannIndex = redisTemplate.opsForValue().increment(&quot;banIndex&quot;);</span>
                }else{
                    //已经被其他线程改变
<span class="nc" id="L165">                    bannIndex = newBanIndex;</span>
                }

<span class="nc" id="L168">                currentSetName = banSetName[(int) (bannIndex % banSetName.length)];</span>
                //启用之前，不管有没有，先删除一下，应该是没有，保险起见
<span class="nc" id="L170">                redisTemplate.delete(currentSetName);</span>
<span class="nc" id="L171">                logger.debug(&quot;banJwt: next ban set =&quot; + currentSetName);</span>
<span class="nc" id="L172">                redisTemplate.opsForSet().add(currentSetName, jwt);</span>
<span class="nc" id="L173">                redisTemplate.expire(currentSetName,jwtExpireTime * 2,TimeUnit.SECONDS);</span>
                // 解锁
<span class="nc" id="L175">                redisTemplate.delete(&quot;banIndexLocker&quot;);</span>
            }
        }
<span class="nc" id="L178">    }</span>

    /**
     * 用户登出
     * @param userId 用户id
     */
    public ReturnObject&lt;Boolean&gt; Logout(Long userId)
    {
//        Set&lt;String&gt; keys = redisTemplate.keys(&quot;*&quot;);
//        for(String z:keys){
//            System.out.println(&quot;userId: &quot;+z);
//        }//测试使用
<span class="fc" id="L190">        redisTemplate.delete(&quot;up_&quot; + userId);</span>
<span class="fc" id="L191">        return new ReturnObject&lt;&gt;(true);</span>
    }

    public ReturnObject&lt;PageInfo&lt;VoObject&gt;&gt; getallusers(String userName, String email,String mobile, Integer page, Integer pageSize){
//        String userName, String email,String mobile, Integer page, Integer pageSize
<span class="fc" id="L196">        ReturnObject&lt;PageInfo&lt;VoObject&gt;&gt; ret = userDao.getUsersMix(userName, email, mobile, page, pageSize);</span>
<span class="fc" id="L197">        return ret;</span>
    }


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>